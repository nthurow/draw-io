<mxfile host="app.diagrams.net" modified="2021-03-08T22:47:45.065Z" agent="5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36" etag="ubymxk_rdx-rMiQVSgk9" version="14.4.4" type="github">
  <diagram name="Page-1" id="9f46799a-70d6-7492-0946-bef42562c5a5">
    <mxGraphModel dx="2373" dy="3309" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1100" pageHeight="850" background="#ffffff" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="w1PzRN34txhDw9UbGB5l-29" value="" style="ellipse;shape=cloud;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="440" y="795" width="180" height="460" as="geometry" />
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-15" value="" style="ellipse;shape=cloud;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="580" y="290" width="180" height="460" as="geometry" />
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-2" value="PersonaProxy" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="224" y="410" width="100" height="300" as="geometry" />
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-3" value="&lt;div style=&quot;text-align: left&quot;&gt;&lt;b&gt;type FetchSessionInfo = &amp;lt;TokenType, SessionType&amp;gt;(authToken: TokenType) =&amp;gt; Promise&amp;lt;SessionType&amp;gt;&lt;/b&gt;&lt;/div&gt;&lt;br&gt;&lt;div style=&quot;text-align: left&quot;&gt;A function which accepts arbitrary data returned from authentication service, and returns more info about the user which will be stored in the user&#39;s session.&lt;/div&gt;&lt;br&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;b&gt;TokenType:&lt;/b&gt;&lt;span&gt;&amp;nbsp;The type of the token received from auth service&lt;/span&gt;&lt;/div&gt;&lt;b&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;b&gt;SessionType:&lt;/b&gt;&lt;span style=&quot;font-weight: normal&quot;&gt;&amp;nbsp;The type which will be returned and added to session&lt;/span&gt;&lt;/div&gt;&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-150" y="70" width="720" height="220" as="geometry" />
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-9" value="" style="shape=umlLifeline;participant=umlActor;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;verticalAlign=top;spacingTop=36;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="360" width="20" height="370" as="geometry" />
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-10" value="fetchPersonaDetails(token)" style="html=1;verticalAlign=bottom;endArrow=block;" parent="w1PzRN34txhDw9UbGB5l-9" target="w1PzRN34txhDw9UbGB5l-2" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="10" y="110" as="sourcePoint" />
            <mxPoint x="90" y="110" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-11" value="IdTokenService" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="440" y="410" width="100" height="300" as="geometry" />
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-12" value="fetchJwt(token)" style="html=1;verticalAlign=bottom;endArrow=block;" parent="1" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="273.5" y="507" as="sourcePoint" />
            <mxPoint x="489.5" y="507" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-13" value="Identity Token API" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="630" y="410" width="100" height="300" as="geometry" />
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-14" value="GET /jwt {token}" style="html=1;verticalAlign=bottom;endArrow=block;" parent="1" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="489.5" y="549" as="sourcePoint" />
            <mxPoint x="679.5" y="549" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-16" value="JWT" style="html=1;verticalAlign=bottom;endArrow=block;" parent="1" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="679.5" y="580" as="sourcePoint" />
            <mxPoint x="489.5" y="580" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-17" value="JWT" style="html=1;verticalAlign=bottom;endArrow=block;" parent="1" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="489.5" y="608" as="sourcePoint" />
            <mxPoint x="273.5" y="608" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-18" value="{jwt: JWT}" style="html=1;verticalAlign=bottom;endArrow=block;" parent="1" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="273.5" y="642" as="sourcePoint" />
            <mxPoint x="49.5" y="642" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-19" value="Portunus" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="234" y="890" width="100" height="300" as="geometry" />
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-20" value="" style="shape=umlLifeline;participant=umlActor;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;verticalAlign=top;spacingTop=36;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="50" y="840" width="20" height="370" as="geometry" />
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-21" value="fetchAbilities(jwt)" style="html=1;verticalAlign=bottom;endArrow=block;" parent="w1PzRN34txhDw9UbGB5l-20" target="w1PzRN34txhDw9UbGB5l-19" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="10" y="110" as="sourcePoint" />
            <mxPoint x="90" y="110" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-23" value="GET /abilities {jwt}" style="html=1;verticalAlign=bottom;endArrow=block;" parent="1" target="w1PzRN34txhDw9UbGB5l-30" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="283.5" y="987" as="sourcePoint" />
            <mxPoint x="499.5" y="987" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-27" value="abilities[]" style="html=1;verticalAlign=bottom;endArrow=block;" parent="1" source="w1PzRN34txhDw9UbGB5l-30" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="499.5" y="1088" as="sourcePoint" />
            <mxPoint x="283.5" y="1088" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-28" value="{abilities}" style="html=1;verticalAlign=bottom;endArrow=block;" parent="1" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="283.5" y="1122" as="sourcePoint" />
            <mxPoint x="59.5" y="1122" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-30" value="Portunus API" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="490" y="890" width="100" height="300" as="geometry" />
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-31" value="" style="shape=umlLifeline;participant=umlActor;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;verticalAlign=top;spacingTop=36;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="-130" y="-575" width="20" height="615" as="geometry" />
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-32" value="AuthProxy" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="70" y="-530" width="100" height="570" as="geometry" />
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-33" value="GET /login" style="html=1;verticalAlign=bottom;endArrow=block;" parent="1" source="w1PzRN34txhDw9UbGB5l-31" target="w1PzRN34txhDw9UbGB5l-32" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-110" y="-460" as="sourcePoint" />
            <mxPoint x="113.5" y="-460" as="targetPoint" />
            <Array as="points">
              <mxPoint x="-50" y="-450" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-34" value="&lt;b&gt;AuthProxyPlugin&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;b&gt;- login(query, headers, req) =&amp;gt; Promise&amp;lt;string&amp;gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&amp;nbsp; A function which should return a redirect URL based on the given query string params, header values, and request object&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;b&gt;- authenticate&amp;lt;SubjectType, TokenType&amp;gt;(body, headers, query, req) =&amp;gt; Promise&amp;lt;{sub: SubjectType, authToken: TokenType}&amp;gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;A function which will be passed various request fields (body, headers, query) and should return an object with the following properties:&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;- sub&lt;/b&gt;: A unique identifier for the user&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;- authToken:&lt;/b&gt;&amp;nbsp;A token representing any other info about the user.&amp;nbsp; This will be passed to the &quot;fetchSessionDetails&quot; function to help generate the user&#39;s session&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;b&gt;- fetchSessionDetails&amp;lt;TokenType, SessionType&amp;gt;(authToken: TokenType) =&amp;gt; Promise&amp;lt;SessionType&amp;gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;A function which will be passed the auth token received from the &quot;authenticate&quot; function, and should return an object containing any additional information that should be stored in the user&#39;s session.&amp;nbsp; This additional information will be accessible when proxying requests in order to help authorize, and will also be injected into proxied request headers.&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;b&gt;- refresh&amp;lt;SessionType&amp;gt;(session: SessionType) =&amp;gt; Promise&amp;lt;SessionType&amp;gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;A function which should refresh the user&#39;s authenticated session, optionally returning new session fields (such as a new refresh token)&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;b&gt;- logout(query, headers, req) =&amp;gt; Promise&amp;lt;string&amp;gt;&amp;nbsp;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;A function which will be passed various request fields and should return a redirect URL.&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;b&gt;NOTES:&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;- &quot;login&quot; and &quot;logout&quot; won&#39;t necessarily have a redirect URL; they could return an object.&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;- Rather than calling the function &quot;refresh&quot;, should we call it &quot;validate&quot;? Then it can not only refresh the session if needed, but can also verify with auth server that it is still valid&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;- Or we could leave &quot;refresh&quot; as-is, and make &quot;validate&quot; a separate function.&amp;nbsp; Then &quot;authenticate&quot; and &quot;refresh&quot; could both return an optional &quot;expiresAt&quot; field, and the auth proxy will be smart enough to call &quot;refresh&quot; if &quot;expiresAt&quot; is passed.&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Session Interface&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;In addition to standard session fields, session interface needs to have properties that represent different access levels for the user and application.&amp;nbsp; For example, one part of the session could be used for server-side session and would be freely modifiable by the user, while other fields should be completely immutable for security reasons.&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;b&gt;- sub: string:&lt;/b&gt;&amp;nbsp;A unique identifier for the user&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;b&gt;- secureSession: {[key: string]: any}:&lt;/b&gt;&amp;nbsp;A key/value pair which contains fields that are immutable.&amp;nbsp; These fields can be set once by the &quot;fetchSessionDetails&quot; function, and once they are set they can not be changed.&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;b&gt;- applicationSession:&amp;nbsp;&lt;/b&gt;&lt;b&gt;{[key: string]: any}:&lt;/b&gt;&lt;span&gt;&amp;nbsp;A key/value pair which contains fields that can be modified by the &lt;i&gt;application&lt;/i&gt;&amp;nbsp;(NOT the user).&amp;nbsp; This would include fields that need to be modified occasionally, such as token expiration times or refresh tokens.&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;&lt;b&gt;- userSession:&amp;nbsp;&lt;/b&gt;&lt;/span&gt;&lt;b&gt;{[key: string]: any}:&lt;/b&gt;&lt;span&gt;&amp;nbsp;A key/value pair which contains fields that can be safely directly altered by the user.&amp;nbsp; This would be useful for things like server-side session.&amp;nbsp; NOTE: Since these fields contain user-changeable data, they should be treated as untrusted input on both the server-side and client-side.&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-216" y="-1340" width="1000" height="660" as="geometry" />
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-35" value="Plugin: AuthProxyPlugin" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;" parent="1" vertex="1">
          <mxGeometry x="334" y="-530" width="136" height="570" as="geometry" />
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-36" value="login(req.query, req.headers, req)" style="html=1;verticalAlign=bottom;endArrow=block;" parent="1" source="w1PzRN34txhDw9UbGB5l-32" target="w1PzRN34txhDw9UbGB5l-35" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="130" y="-426" as="sourcePoint" />
            <mxPoint x="360" y="-426" as="targetPoint" />
            <Array as="points">
              <mxPoint x="190.5" y="-426" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-37" value="redirectURI" style="html=1;verticalAlign=bottom;endArrow=block;" parent="1" source="w1PzRN34txhDw9UbGB5l-35" target="w1PzRN34txhDw9UbGB5l-32" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="380" y="-380" as="sourcePoint" />
            <mxPoint x="164" y="-380" as="targetPoint" />
            <Array as="points">
              <mxPoint x="170" y="-370" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="w1PzRN34txhDw9UbGB5l-38" value="res.redirect(redirectURI)" style="html=1;verticalAlign=bottom;endArrow=block;" parent="1" source="w1PzRN34txhDw9UbGB5l-32" target="w1PzRN34txhDw9UbGB5l-31" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="100" y="-330" as="sourcePoint" />
            <mxPoint x="-90" y="-330" as="targetPoint" />
            <Array as="points">
              <mxPoint x="-79.5" y="-330" />
            </Array>
          </mxGeometry>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
